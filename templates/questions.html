{% extends "base.html" %}
{% block title %}CÃ¢u há»i - {{ course['title_vi'] or course['title_en'] }}{% endblock %}
{% block content %}
<a href="{{ url_for('admin_panel') }}#content" class="btn btn-outline btn-sm" style="margin-bottom:14px">â† Quay láº¡i</a>

<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:10px">
        <div>
            <h3 style="color:var(--primary);margin-bottom:4px;font-size:16px">ğŸ“ NgÃ¢n hÃ ng cÃ¢u há»i / Question Bank</h3>
            <p style="color:var(--secondary);font-size:13px">{{ course['title_vi'] or course['title_en'] }}</p>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
            <span class="badge badge-info">{{ questions|length }} cÃ¢u há»i</span>
            <span class="badge badge-warning">Láº¥y {{ course['quiz_count'] or questions|length }} cÃ¢u</span>
            <span class="badge badge-success">Äáº¡t: {{ course['pass_score'] }}</span>
        </div>
    </div>
</div>

<!-- QUIZ SETTINGS -->
<div class="card" style="border-left:4px solid var(--yellow)">
    <h4 style="color:var(--primary);font-size:14px;margin-bottom:10px">âš™ï¸ CÃ i Ä‘áº·t bÃ i thi / Quiz Settings</h4>
    <form method="POST" style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end">
        <input type="hidden" name="action" value="update_settings">
        <div style="flex:1;min-width:120px"><label style="font-size:11px;font-weight:600;color:#555">Sá»‘ cÃ¢u láº¥y ngáº«u nhiÃªn<br><span style="font-weight:400;color:#888">(0 = táº¥t cáº£ {{ questions|length }} cÃ¢u)</span></label><input type="number" name="quiz_count" class="form-control" value="{{ course['quiz_count'] or 0 }}" min="0" max="{{ questions|length }}"></div>
        <div style="flex:1;min-width:100px"><label style="font-size:11px;font-weight:600;color:#555">Äiá»ƒm Ä‘áº¡t</label><input type="number" name="pass_score" class="form-control" value="{{ course['pass_score'] }}" min="1"></div>
        <div style="flex:1;min-width:100px"><label style="font-size:11px;font-weight:600;color:#555">Max lÆ°á»£t thi</label><input type="number" name="max_attempts" class="form-control" value="{{ course['max_attempts'] or 3 }}" min="1" max="10"></div>
        <button type="submit" class="btn btn-primary btn-sm" style="height:38px">ğŸ’¾ LÆ°u cÃ i Ä‘áº·t</button>
    </form>
</div>

<!-- RETEST REQUEST -->
<div class="card" style="border-left:4px solid var(--danger)">
    <h4 style="color:var(--danger);font-size:14px;margin-bottom:10px">ğŸ”„ YÃªu cáº§u lÃ m test / Request Retest</h4>
    <p style="font-size:12px;color:#666;margin-bottom:10px">Reset káº¿t quáº£ (náº¿u cÃ³) vÃ  gá»­i email yÃªu cáº§u nhÃ¢n viÃªn hoÃ n thÃ nh bÃ i test.</p>
    <form method="POST" action="{{ url_for('request_retest', cid=course['id']) }}">
        <div class="form-group">
            <label style="font-size:11px;font-weight:600;color:#555">Gá»­i Ä‘áº¿n</label>
            <select name="target_type" class="form-control" id="rt-type" onchange="toggleRT()">
                <option value="all">Táº¥t cáº£ nhÃ¢n viÃªn</option>
                <option value="department">Theo phÃ²ng ban</option>
                <option value="team">Theo team</option>
                <option value="individual">CÃ¡ nhÃ¢n</option>
            </select>
        </div>
        <div class="form-group" id="rt-dept-wrap" style="display:none">
            <label style="font-size:11px;font-weight:600;color:#555">PhÃ²ng ban</label>
            <select class="form-control" id="rt-dept" name="_dept_tmp">
                {% for d in DEPARTMENTS %}<option value="{{ d }}">{{ d }}</option>{% endfor %}
            </select>
        </div>
        <div class="form-group" id="rt-team-wrap" style="display:none">
            <label style="font-size:11px;font-weight:600;color:#555">Team</label>
            <select class="form-control" id="rt-team" name="_team_tmp">
                {% for t in TEAMS %}<option value="{{ t }}">{{ t }}</option>{% endfor %}
            </select>
        </div>
        <div class="form-group" id="rt-email-wrap" style="display:none">
            <label style="font-size:11px;font-weight:600;color:#555">Email cÃ¡ nhÃ¢n</label>
            <input type="email" class="form-control" id="rt-email" name="_email_tmp" placeholder="email@manimedicalhanoi.com">
        </div>
        <div class="form-group">
            <label style="font-size:11px;font-weight:600;color:#555">Deadline hoÃ n thÃ nh</label>
            <input type="date" name="deadline" class="form-control">
        </div>
        <button type="submit" class="btn btn-danger btn-sm"
                onclick="return confirm('Gá»­i yÃªu cáº§u lÃ m test? Káº¿t quáº£ cÅ© sáº½ bá»‹ reset cho cÃ¡c nhÃ¢n sá»± Ä‘Æ°á»£c chá»n.')">
            ğŸ”„ Gá»­i yÃªu cáº§u
        </button>
    </form>
</div>

<!-- IMPORT CSV: DRAG & DROP + PASTE -->
<div class="card">
    <h4 style="color:var(--primary);font-size:14px;margin-bottom:10px">ğŸ“ ThÃªm cÃ¢u há»i tá»« CSV / Import from CSV</h4>
    <p style="font-size:11px;color:#888;margin-bottom:10px">Äá»‹nh dáº¡ng: <code style="background:#f0f0f0;padding:2px 6px;border-radius:4px">CÃ¢u há»i|A|B|C|D|Ä‘Ã¡p Ã¡n(a/b/c/d)|giáº£i thÃ­ch</code></p>

    <!-- File drag & drop -->
    <form method="POST" enctype="multipart/form-data" id="csv-file-form">
        <input type="hidden" name="action" value="csv_file">
        <div class="drop-zone" id="drop-zone" onclick="document.getElementById('csv-file-input').click()">
            <p style="font-size:28px;margin-bottom:8px">ğŸ“‚</p>
            <p><strong>KÃ©o tháº£ file CSV vÃ o Ä‘Ã¢y</strong></p>
            <p>hoáº·c nháº¥p Ä‘á»ƒ chá»n file / Drop CSV file here or click to browse</p>
            <p id="file-name" style="color:var(--secondary);font-weight:600;margin-top:8px;display:none"></p>
        </div>
        <input type="file" id="csv-file-input" name="csv_file" accept=".csv,.txt" style="display:none" onchange="handleFileSelect(this)">
        <button type="submit" id="file-submit-btn" class="btn btn-secondary btn-sm" style="margin-top:10px;display:none">ğŸ“¥ Import file</button>
    </form>

    <div style="position:relative;margin:14px 0"><div style="border-top:1px solid #ddd"></div><span style="position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:#fff;padding:0 10px;color:#888;font-size:12px">hoáº·c dÃ¡n text / or paste text</span></div>

    <!-- Text paste -->
    <form method="POST" id="csv-text-form">
        <input type="hidden" name="action" value="csv">
        <textarea name="csv_data" class="form-control" id="csv-textarea" style="font-family:monospace;font-size:11px;min-height:90px" placeholder="CÃ¢u há»i 1|ÄÃ¡p Ã¡n A|ÄÃ¡p Ã¡n B|ÄÃ¡p Ã¡n C|ÄÃ¡p Ã¡n D|a|Giáº£i thÃ­ch&#10;CÃ¢u há»i 2|ÄÃ¡p Ã¡n A|ÄÃ¡p Ã¡n B|ÄÃ¡p Ã¡n C|ÄÃ¡p Ã¡n D|b|Giáº£i thÃ­ch"></textarea>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <span id="csv-preview" style="font-size:11px;color:#888"></span>
            <button type="submit" class="btn btn-secondary btn-sm">ğŸ“¥ Import text CSV</button>
        </div>
    </form>
</div>

<!-- ADD MANUAL -->
<details class="card" style="cursor:pointer">
    <summary style="font-weight:600;color:var(--primary);font-size:14px;padding:4px 0">â• ThÃªm cÃ¢u há»i thá»§ cÃ´ng / Add manually</summary>
    <div style="margin-top:14px">
        <form method="POST">
            <input type="hidden" name="action" value="add">
            <div class="form-group"><label>Ná»™i dung cÃ¢u há»i *</label><textarea name="text" class="form-control" required placeholder="Nháº­p cÃ¢u há»i..."></textarea></div>
            <div class="form-row">
                <div class="form-group"><label>A *</label><input type="text" name="option_a" class="form-control" required></div>
                <div class="form-group"><label>B *</label><input type="text" name="option_b" class="form-control" required></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>C</label><input type="text" name="option_c" class="form-control"></div>
                <div class="form-group"><label>D</label><input type="text" name="option_d" class="form-control"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>ÄÃ¡p Ã¡n Ä‘Ãºng</label><select name="answer" class="form-control"><option value="a">A</option><option value="b">B</option><option value="c">C</option><option value="d">D</option></select></div>
                <div class="form-group"><label>Giáº£i thÃ­ch</label><input type="text" name="explanation" class="form-control"></div>
            </div>
            <button type="submit" class="btn btn-primary btn-sm">ğŸ’¾ ThÃªm cÃ¢u há»i</button>
        </form>
    </div>
</details>

<!-- QUESTIONS LIST -->
<div class="card">
    <h4 style="color:var(--primary);font-size:14px;margin-bottom:12px">ğŸ“‹ Danh sÃ¡ch cÃ¢u há»i ({{ questions|length }})</h4>
    {% if questions|length == 0 %}
    <p style="text-align:center;color:#888;padding:20px">ChÆ°a cÃ³ cÃ¢u há»i nÃ o. ThÃªm báº±ng CSV hoáº·c thá»§ cÃ´ng á»Ÿ trÃªn.</p>
    {% else %}
    {% for q in questions %}
    <div style="padding:10px 0;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:flex-start;gap:10px">
        <div style="flex:1">
            <div style="display:flex;gap:6px;align-items:center;margin-bottom:4px">
                <span style="font-size:11px;color:#888;font-weight:600">{{ loop.index }}.</span>
                {% if q['source']=='csv' %}<span style="font-size:9px;background:#e8f4fd;color:var(--secondary);padding:1px 6px;border-radius:8px">CSV</span>{% elif q['source']=='manual' %}<span style="font-size:9px;background:#fdf0e8;color:#bf6a00;padding:1px 6px;border-radius:8px">Manual</span>{% endif %}
            </div>
            <p style="font-weight:600;font-size:13px;margin-bottom:4px">{{ q['text'] }}</p>
            <div style="font-size:11px;color:#666;display:flex;flex-wrap:wrap;gap:8px">
                <span class="q-ans {% if q['answer']=='a' %}q-ans-correct{% endif %}">A: {{ q['option_a'] }}</span>
                <span class="q-ans {% if q['answer']=='b' %}q-ans-correct{% endif %}">B: {{ q['option_b'] }}</span>
                {% if q['option_c'] %}<span class="q-ans {% if q['answer']=='c' %}q-ans-correct{% endif %}">C: {{ q['option_c'] }}</span>{% endif %}
                {% if q['option_d'] %}<span class="q-ans {% if q['answer']=='d' %}q-ans-correct{% endif %}">D: {{ q['option_d'] }}</span>{% endif %}
            </div>
            {% if q['explanation'] %}<p style="font-size:10px;color:#888;font-style:italic;margin-top:2px">ğŸ’¡ {{ q['explanation'] }}</p>{% endif %}
        </div>
        <form method="POST" onsubmit="return confirm('XÃ³a cÃ¢u há»i nÃ y?')"><input type="hidden" name="action" value="delete"><input type="hidden" name="question_id" value="{{ q['id'] }}"><button type="submit" class="btn btn-danger btn-sm">ğŸ—‘</button></form>
    </div>
    {% endfor %}
    {% endif %}
</div>

<script>
// Drag & Drop
const dz=document.getElementById('drop-zone');
const fi=document.getElementById('csv-file-input');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('dragover')});
dz.addEventListener('dragleave',()=>dz.classList.remove('dragover'));
dz.addEventListener('drop',e=>{
    e.preventDefault();dz.classList.remove('dragover');
    if(e.dataTransfer.files.length){fi.files=e.dataTransfer.files;handleFileSelect(fi)}
});
function handleFileSelect(input){
    if(input.files.length){
        const fn=document.getElementById('file-name');
        fn.textContent='ğŸ“„ '+input.files[0].name;fn.style.display='block';
        document.getElementById('file-submit-btn').style.display='inline-flex';
    }
}
// CSV preview
document.getElementById('csv-textarea').addEventListener('input',function(){
    const lines=this.value.trim().split('\n').filter(l=>l.trim());
    document.getElementById('csv-preview').textContent=lines.length>0?lines.length+' dÃ²ng / lines':'';
});
// Retest toggle (Gá»­i Ä‘áº¿n theo phÃ²ng ban / team / cÃ¡ nhÃ¢n)
function toggleRT(){
    var v=document.getElementById('rt-type').value;
    var deptWrap=document.getElementById('rt-dept-wrap');
    var teamWrap=document.getElementById('rt-team-wrap');
    var emailWrap=document.getElementById('rt-email-wrap');
    var dept=document.getElementById('rt-dept');
    var team=document.getElementById('rt-team');
    var email=document.getElementById('rt-email');

    // reset names
    dept.name='_dept_tmp'; team.name='_team_tmp'; email.name='_email_tmp';

    if(v==='department'){
        deptWrap.style.display='block'; teamWrap.style.display='none'; emailWrap.style.display='none';
        dept.name='target_value';
    }else if(v==='team'){
        deptWrap.style.display='none'; teamWrap.style.display='block'; emailWrap.style.display='none';
        team.name='target_value';
    }else if(v==='individual'){
        deptWrap.style.display='none'; teamWrap.style.display='none'; emailWrap.style.display='block';
        email.name='target_value';
    }else{
        deptWrap.style.display='none'; teamWrap.style.display='none'; emailWrap.style.display='none';
    }
}
toggleRT();
</script>
{% endblock %}
