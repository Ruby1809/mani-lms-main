{% extends "base.html" %}
{% block title %}Quáº£n trá»‹ - MANI Learning Hub{% endblock %}
{% block content %}
<h2 style="color:var(--primary);margin-bottom:16px">âš™ï¸ Quáº£n trá»‹ / Admin Panel</h2>
<div class="stats-grid">
    <div class="stat-card" style="border-top:4px solid var(--primary)"><div class="emoji">ğŸ‘¥</div><div class="num">{{ stats.total_users }}</div><div class="label">NgÆ°á»i dÃ¹ng</div></div>
    <div class="stat-card" style="border-top:4px solid var(--secondary)"><div class="emoji">ğŸ“š</div><div class="num">{{ stats.total_courses }}</div><div class="label">KhÃ³a há»c</div></div>
    <div class="stat-card" style="border-top:4px solid #28A745"><div class="emoji">ğŸ†</div><div class="num">{{ stats.total_certs }}</div><div class="label">Chá»©ng chá»‰</div></div>
    <div class="stat-card" style="border-top:4px solid var(--yellow)"><div class="emoji">ğŸ“</div><div class="num">{{ stats.total_attempts }}</div><div class="label">LÆ°á»£t thi</div></div>
</div>
<div class="tabs">
    <a href="#users" class="active" onclick="showAT('users',this)" id="tl-users">ğŸ‘¥ NgÆ°á»i dÃ¹ng</a>
    <a href="#content" onclick="showAT('content',this)" id="tl-content">ğŸ“‹ Ná»™i dung</a>
    <a href="#emails" onclick="showAT('emails',this)" id="tl-emails">ğŸ“§ Email & SMTP</a>
    <a href="#remind" onclick="showAT('remind',this)" id="tl-remind">ğŸ”” Nháº¯c nhá»Ÿ</a>
</div>

<!-- USERS TAB -->
<div id="at-users" class="atab">
<div class="card" style="padding:0;overflow:hidden"><div class="table-wrap"><table>
    <thead><tr><th>TÃªn</th><th>Email</th><th>Department</th><th>Team</th><th>Vai trÃ²</th><th>XÃ¡c nháº­n</th><th></th></tr></thead>
    <tbody>
    {% for u in users %}<tr>
        <td><strong>{{ u['name'] }}</strong><br><span style="font-size:10px;color:#888">{{ u['job_title'] or '' }} â€¢ {{ u['job_level'] or '' }}</span></td>
        <td style="font-size:11px;word-break:break-all">{{ u['email'] }}</td>
        <td><span class="tag">{{ u['department'] or '' }}</span></td>
        <td style="font-size:11px">{{ u['team'] or 'N/A' }}</td>
        <td><span class="badge badge-{{ u['role'] }}">{{ u['role'] }}</span></td>
        <td>{% if u['verified'] %}<span class="badge badge-success">âœ“</span>{% else %}<span class="badge badge-warning">â³</span>{% endif %}</td>
        <td><button class="btn btn-outline btn-sm" onclick="openEU({{ u['id'] }},'{{ u['name']|replace("'","") }}','{{ u['department'] or '' }}','{{ u['team'] or 'N/A' }}','{{ u['job_title'] or 'Other' }}','{{ u['job_level'] or 'Staff' }}','{{ u['role'] }}','{{ u['status'] or 'active' }}')">âœï¸</button></td>
    </tr>{% endfor %}
    </tbody>
</table></div></div>
</div>

<!-- CONTENT TAB -->
<div id="at-content" class="atab" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <h3 style="color:var(--primary);font-size:16px">Quáº£n lÃ½ khÃ³a há»c</h3>
        <a href="{{ url_for('new_course') }}" class="btn btn-primary">â• ThÃªm khÃ³a há»c</a>
    </div>
    {% for c in courses %}
    {% set trainer = (users | selectattr('email','equalto',c['created_by']) | list | first) %}
    <div class="card" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;padding:14px">
        <div style="flex:1;min-width:220px">
            <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap">
                <span class="tag">{{ c['category'] }}</span>
                <span class="badge badge-info" style="font-size:10px">{{ q_counts.get(c['id'],0) }} cÃ¢u</span>
            </div>
            <h4 style="margin:4px 0;color:var(--primary);font-size:14px">{{ c['title_vi'] or c['title_en'] }}</h4>
            {% set groups = c['target_groups'] | from_json %}
            {% if groups %}<div style="display:flex;gap:3px;flex-wrap:wrap;margin-top:3px">{% for g in groups %}<span style="font-size:9px;background:#f0f0f0;padding:1px 6px;border-radius:8px;color:#666">{{ g }}</span>{% endfor %}</div>{% endif %}
            <div style="margin-top:6px;font-size:11px;color:#666">
                <span>Trainer: <strong>{{ trainer['name'] if trainer else 'N/A' }}</strong></span>
                <span style="margin-left:8px">NgÃ y táº¡o: {{ (c['created_at'] or '')[:10] }}</span>
            </div>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
            <a href="{{ url_for('manage_questions',cid=c['id']) }}" class="btn btn-secondary btn-sm">ğŸ“ CÃ¢u há»i</a>
            <a href="{{ url_for('edit_course',cid=c['id']) }}" class="btn btn-outline btn-sm">âœï¸ Sá»­a</a>
            <form method="POST" action="{{ url_for('delete_course',cid=c['id']) }}" style="display:inline" onsubmit="return confirm('XÃ³a?')"><button type="submit" class="btn btn-danger btn-sm">ğŸ—‘</button></form>
        </div>
    </div>
    {% endfor %}
</div>

<!-- EMAILS & SMTP TAB -->
<div id="at-emails" class="atab" style="display:none">
    <!-- SMTP Test -->
    <div class="card" style="border-left:4px solid var(--secondary)">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
            <div><h4 style="color:var(--primary);font-size:14px">ğŸ“§ Kiá»ƒm tra SMTP / Test Email</h4>
            <p style="font-size:12px;color:#888">Gá»­i email test Ä‘áº¿n tÃ i khoáº£n Admin cá»§a báº¡n.</p></div>
            <a href="{{ url_for('test_smtp') }}" class="btn btn-secondary btn-sm" onclick="return confirm('Gá»­i email test?')">ğŸ§ª Test SMTP</a>
        </div>
        <div style="background:#f0f7fb;padding:10px;border-radius:8px;margin-top:10px;font-size:11px;color:var(--secondary)">
            <strong>Cáº¥u hÃ¬nh hiá»‡n táº¡i:</strong> SMTP_SERVER, SMTP_PORT, SMTP_USER, SMTP_PASS â†’ thiáº¿t láº­p trong Environment Variables trÃªn Render.
        </div>
    </div>
    <!-- Whitelist Management -->
    <div class="card">
        <h4 style="color:var(--primary);font-size:14px;margin-bottom:10px">ğŸ” Danh sÃ¡ch Email Ä‘Æ°á»£c phÃ©p Ä‘Äƒng kÃ½ ({{ allowed_emails|length }})</h4>
        {% if user['role'] == 'admin' %}
        <form method="POST" action="{{ url_for('add_allowed_email') }}" style="display:flex;flex-direction:column;gap:8px;margin-bottom:14px">
            <div style="display:flex;gap:8px;flex-wrap:wrap">
                <input type="email" name="email" class="form-control" style="flex:2;min-width:200px" placeholder="email@manimedicalhanoi.com" required>
                <input type="text" name="note" class="form-control" style="flex:1;min-width:120px" placeholder="Ghi chÃº (tÃ¹y chá»n)">
            </div>
            <div class="form-row">
                <div class="form-group" style="margin-bottom:0">
                    <label style="font-size:11px;font-weight:600;color:#555">Máº­t kháº©u Ä‘Äƒng nháº­p láº§n Ä‘áº§u (tÃ¹y chá»n)</label>
                    <input type="password" name="initial_password" class="form-control" placeholder="Náº¿u nháº­p, tÃ i khoáº£n sáº½ Ä‘Äƒng nháº­p báº±ng máº­t kháº©u nÃ y láº§n Ä‘áº§u.">
                </div>
            </div>
            <div style="display:flex;justify-content:flex-end">
                <button type="submit" class="btn btn-primary btn-sm">â• ThÃªm</button>
            </div>
        </form>
        {% endif %}
        <div class="table-wrap"><table>
            <thead><tr><th>Email</th><th>Ghi chÃº</th><th>Tráº¡ng thÃ¡i</th><th>NgÃ y thÃªm</th>{% if user['role']=='admin' %}<th></th>{% endif %}</tr></thead>
            <tbody>
            {% for e in allowed_emails %}<tr style="{% if not e['active'] %}opacity:.5{% endif %}">
                <td style="font-size:12px;word-break:break-all">{{ e['email'] }}</td>
                <td style="font-size:11px;color:#888">{{ e['note'] or '' }}</td>
                <td>{% if e['active'] %}<span class="badge badge-success">Active</span>{% else %}<span class="badge badge-danger">Disabled</span>{% endif %}</td>
                <td style="font-size:10px;color:#888">{{ (e['created_at'] or '')[:10] }}</td>
                {% if user['role']=='admin' %}
                <td style="white-space:nowrap">
                    <form method="POST" action="{{ url_for('toggle_email', eid=e['id']) }}" style="display:inline"><button type="submit" class="btn btn-outline btn-sm">{% if e['active'] %}ğŸ”’{% else %}ğŸ”“{% endif %}</button></form>
                    <form method="POST" action="{{ url_for('delete_email', eid=e['id']) }}" style="display:inline" onsubmit="return confirm('XÃ³a email nÃ y?')"><button type="submit" class="btn btn-danger btn-sm">ğŸ—‘</button></form>
                </td>
                {% endif %}
            </tr>{% endfor %}
            </tbody>
        </table></div>
    </div>
</div>

<!-- REMINDER TAB -->
<div id="at-remind" class="atab" style="display:none">
<div class="card">
    <h3 style="color:var(--primary);margin-bottom:14px;font-size:16px">ğŸ“§ Gá»­i nháº¯c nhá»Ÿ hoÃ n thÃ nh khÃ³a há»c</h3>
    <form method="POST" action="{{ url_for('send_reminder') }}">
        <div class="form-group">
            <label>Chá»n khÃ³a há»c *</label>
            <select name="course_id" class="form-control" required>
                <option value="">-- Chá»n --</option>
                {% for c in courses %}<option value="{{ c['id'] }}">{{ c['title_vi'] or c['title_en'] }}</option>{% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label>Gá»­i Ä‘áº¿n</label>
            <select name="target_type" class="form-control" id="rem-type" onchange="toggleRT()">
                <option value="all">Táº¥t cáº£ nhÃ¢n viÃªn</option>
                <option value="department">Theo phÃ²ng ban</option>
                <option value="team">Theo team</option>
                <option value="individual">CÃ¡ nhÃ¢n</option>
            </select>
        </div>
        <div class="form-group" id="rem-dept" style="display:none">
            <label>PhÃ²ng ban</label>
            <select name="_dept_tmp" class="form-control" id="rem-dept-val">
                {% for d in DEPARTMENTS %}<option value="{{ d }}">{{ d }}</option>{% endfor %}
            </select>
        </div>
        <div class="form-group" id="rem-team" style="display:none">
            <label>Team</label>
            <select name="_team_tmp" class="form-control" id="rem-team-val">
                {% for t in TEAMS %}<option value="{{ t }}">{{ t }}</option>{% endfor %}
            </select>
        </div>
        <div class="form-group" id="rem-email" style="display:none">
            <label>Email</label>
            <input type="email" name="_email_tmp" class="form-control" id="rem-email-val" placeholder="email@manimedicalhanoi.com">
        </div>
        <div class="form-group">
            <label>Deadline hoÃ n thÃ nh</label>
            <input type="date" name="deadline" class="form-control">
        </div>
        <div class="form-group">
            <label>Ná»™i dung thÃªm (tÃ¹y chá»n)</label>
            <textarea name="message" class="form-control" rows="3" placeholder="ThÃ´ng Ä‘iá»‡p bá»• sung, náº¿u cÃ³. Há»‡ thá»‘ng sáº½ tá»± Ä‘á»™ng thÃªm cÃ¢u nháº¯c hoÃ n thÃ nh khÃ³a há»c vÃ  deadline."></textarea>
        </div>
        <button type="submit" class="btn btn-primary" onclick="return confirm('Gá»­i nháº¯c nhá»Ÿ?')">ğŸ“§ Gá»­i nháº¯c nhá»Ÿ</button>
    </form>
</div>
</div>

<!-- EDIT USER MODAL -->
<div id="eu-modal" class="modal-overlay" onclick="if(event.target===this)closeEU()">
<div class="modal-box">
    <h3 style="color:var(--primary);margin-bottom:16px">Chá»‰nh sá»­a: <span id="eu-name"></span></h3>
    <form method="POST" id="eu-form">
        <div class="form-row">
            <div class="form-group"><label>Department</label><select name="department" id="eu-dept" class="form-control">{% for d in DEPARTMENTS %}<option value="{{ d }}">{{ d }}</option>{% endfor %}</select></div>
            <div class="form-group"><label>Team</label><select name="team" id="eu-team" class="form-control">{% for t in TEAMS %}<option value="{{ t }}">{{ t }}</option>{% endfor %}</select></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>Job Title</label><select name="job_title" id="eu-jt" class="form-control">{% for j in JOB_TITLES %}<option value="{{ j }}">{{ j }}</option>{% endfor %}</select></div>
            <div class="form-group"><label>Job Level</label><select name="job_level" id="eu-jl" class="form-control">{% for l in JOB_LEVELS %}<option value="{{ l }}">{{ l }}</option>{% endfor %}</select></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>Vai trÃ²</label><select name="role" id="eu-role" class="form-control"><option value="learner">Learner</option><option value="trainer">Trainer</option>{% if user['role']=='admin' %}<option value="admin">Admin</option>{% endif %}</select></div>
            <div class="form-group"><label>Tráº¡ng thÃ¡i</label><select name="status" id="eu-status" class="form-control"><option value="active">Active</option><option value="inactive">Inactive</option></select></div>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px">
            <button type="button" onclick="closeEU()" class="btn btn-outline">Há»§y</button>
            <button type="submit" class="btn btn-primary">ğŸ’¾ LÆ°u</button>
        </div>
    </form>
</div>
</div>

<script>
function showAT(n,el){document.querySelectorAll('.atab').forEach(t=>t.style.display='none');document.querySelectorAll('.tabs a').forEach(a=>a.classList.remove('active'));document.getElementById('at-'+n).style.display='block';el.classList.add('active')}
['users','content','emails','remind'].forEach(h=>{if(location.hash==='#'+h){const el=document.getElementById('tl-'+h);if(el)showAT(h,el)}});
function openEU(id,name,dept,team,jt,jl,role,status){
    document.getElementById('eu-form').action='/admin/user/'+id+'/update';
    document.getElementById('eu-name').textContent=name;
    document.getElementById('eu-dept').value=dept;document.getElementById('eu-team').value=team;
    document.getElementById('eu-jt').value=jt;document.getElementById('eu-jl').value=jl;
    document.getElementById('eu-role').value=role;document.getElementById('eu-status').value=status;
    document.getElementById('eu-modal').classList.add('show');
}
function closeEU(){document.getElementById('eu-modal').classList.remove('show')}
function toggleRT(){
    var v=document.getElementById('rem-type').value;
    var dept=document.getElementById('rem-dept');
    var team=document.getElementById('rem-team');
    var email=document.getElementById('rem-email');
    var deptVal=document.getElementById('rem-dept-val');
    var teamVal=document.getElementById('rem-team-val');
    var emailVal=document.getElementById('rem-email-val');

    dept.style.display='none'; team.style.display='none'; email.style.display='none';
    deptVal.name='_dept_tmp'; teamVal.name='_team_tmp'; emailVal.name='_email_tmp';

    if(v==='department'){
        dept.style.display='block'; deptVal.name='target_value';
    }else if(v==='team'){
        team.style.display='block'; teamVal.name='target_value';
    }else if(v==='individual'){
        email.style.display='block'; emailVal.name='target_value';
    }
}
toggleRT();
</script>
{% endblock %}
